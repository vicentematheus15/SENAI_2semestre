--1
CREATE OR REPLACE FUNCTION FN_TOTAL_PEDIDO(ID_PEDIDO INT)
RETURNS NUMERIC AS $$
DECLARE
	TOTAL NUMERIC = 0;
BEGIN
	SELECT SUM(P.VALOR_UNITARIO * IP.QUANTIDADE)
	INTO TOTAL
	FROM PRODUTO P, ITEM_PEDIDO IP
	WHERE P.IDPRODUTO = IP.IDPRODUTO
	AND IP.IDPEDIDO = ID_PEDIDO;
	RETURN COALESCE(TOTAL, 0);
END; 
$$
LANGUAGE PLPGSQL;

SELECT FN_TOTAL_PEDIDO(5)

--2
CREATE OR REPLACE FUNCTION FN_QTD_PEDIDOS_CLIENTE(ID_CLIENTE INT)
RETURNS INT AS $$
DECLARE
QTD_PEDIDOS NUMERIC = 0;
BEGIN
	SELECT COUNT(IDCLIENTE) 
	INTO QTD_PEDIDOS
	FROM PEDIDO
	WHERE IDCLIENTE = ID_CLIENTE;
	RETURN QTD_PEDIDOS;
END;
$$
LANGUAGE PLPGSQL;

SELECT FN_QTD_PEDIDOS_CLIENTE(1)


--3
CREATE OR REPLACE FUNCTION  FN_CLIENTES_POR_UF(SIGLA_UF CHAR(2))
RETURNS TABLE(IDCLIENTE INT, NOME TEXT, UF TEXT) AS $$
BEGIN
	RETURN QUERY
		SELECT C.IDCLIENTE::INT, C.NOME::TEXT, C.UF::TEXT
		FROM CLIENTE C
		WHERE C.UF LIKE SIGLA_UF;
END;
$$
LANGUAGE PLPGSQL;

SELECT * FROM FN_CLIENTES_POR_UF('SC')



--4
CREATE OR REPLACE FUNCTION fn_media_pedidos_vendedor(id_vendedor INT)
RETURNS NUMERIC AS $$
BEGIN
		RETURN(SELECT AVG(VALOR)
		FROM PEDIDO
		WHERE IDVENDEDOR = id_vendedor);
END;
$$
LANGUAGE PLPGSQL;

SELECT fn_media_pedidos_vendedor(5)



--5
CREATE OR REPLACE FUNCTION fn_nome_cliente(cpf_cliente VARCHAR)
RETURNS VARCHAR AS $$
DECLARE NOME_CLIENTE VARCHAR;
BEGIN
	SELECT NOME 
	INTO NOME_CLIENTE
	FROM CLIENTE 
	WHERE CPF = cpf_cliente;
	RETURN COALESCE(NOME_CLIENTE, 'Cliente n√£o encontrado');
END;
$$
LANGUAGE PLPGSQL;

SELECT fn_nome_cliente('88828383821')